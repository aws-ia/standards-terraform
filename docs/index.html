<!doctype html><html class=no-js lang=en-us prefix="og: https://ogp.me/ns# fb: https://ogp.me/ns/fb#"><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta property="og:title" content="The AWS Integration & Automation team's best practices for Terraform"><meta property="og:type" content="website"><meta property="og:url" content><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name=generator content="Hugo 0.92.2"><meta name=description content="AWS IA Terraform Module Standards"><meta name=author content="The AWS Integration & Automation team"><link rel="shortcut icon" href=./images/logo.png type=image/png><link rel=icon href=./images/logo.png type=image/png><title>The AWS Integration & Automation team's best practices for Terraform :: The AWS Integration & Automation team's best practices for Terraform</title><link href=./css/nucleus.css?1645718475 rel=stylesheet><link href=./css/fontawesome-all.min.css?1645718475 rel=stylesheet><link href=./css/hybrid.css?1645718475 rel=stylesheet><link href=./css/featherlight.min.css?1645718475 rel=stylesheet><link href=./css/perfect-scrollbar.min.css?1645718475 rel=stylesheet><link href=./css/auto-complete.css?1645718475 rel=stylesheet><link href=./css/atom-one-dark-reasonable.css?1645718475 rel=stylesheet><link href=./css/theme.css?1645718475 rel=stylesheet><link href=./css/hugo-theme.css?1645718475 rel=stylesheet><link href=./css/theme-aws.css?1645718475 rel=stylesheet><script src=./js/jquery-3.5.1.min.js?1645718475></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}:not(pre)>code+span.copy-to-clipboard{display:none}</style></head><body data-url=./><nav id=sidebar><div id=header-wrapper><div id=header><div><a href=./ title="Go home"><img style=vertical-align:middle src=./images/logo.png height=200px></a></div></div><div class=searchbox><label for=search-by><i class="fas fa-search"></i></label>
<input data-search-input id=search-by type=search placeholder=Search...>
<span data-search-clear><i class="fas fa-times"></i></span></div><script type=text/javascript src=./js/lunr.min.js?1645718475></script>
<script type=text/javascript src=./js/auto-complete.js?1645718475></script>
<script type=text/javascript>var baseurl="https://aws-ia.github.io/standards-terraform"</script><script type=text/javascript src=./js/search.js?1645718475></script></div><div class=highlightable><ul class=topics><li data-nav-id=/faq/ title="Frequently asked questions (FAQ)" class=dd-item><a href=./faq/>FAQ</a></li><li data-nav-id=/administrative/ title=Administrative class=dd-item><a href=./administrative/>Administrative</a></li></ul><section id=shortcuts><h3>More</h3><ul><li><a class=padding href=https://github.com/aws-ia><i class="fab fa-github"></i> GitHub</a></li><li><a class=padding href=https://aws.amazon.com/quickstart/architecture/terraform-modules-on-aws/><i class="fab fa-aws"></i> Catalog</a></li><li><a class=padding href=https://aws.amazon.com/quickstart/architecture/terraform-modules-on-aws/>Registry</a></li></ul></section><section id=footer><left><a href="https://aws.amazon.com/privacy/?nc1=f_pr">Privacy</a> | <a href="https://aws.amazon.com/terms/?nc1=f_pr">Site Terms</a> | &copy; 2022, Amazon Web Services, Inc. or its affiliates. All rights reserved.</left></section></div></nav><section id=body><div id=overlay></div><div class="padding highlightable"><div id=chapter><div id=body-inner><h1>The AWS Integration & Automation team's best practices for Terraform</h1><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i> navigation</a></span><p>The standards and guide-lines detailed below are a set of working rules and principles for writing modules that will be stewarded by the AWS I&A team. It is based on input from many experienced Terraform users at AWS, HashiCorp, and community grown conventions.</p><p>We have standardized on the official <a href=https://www.terraform.io/docs/glossary target=_blank rel="noopener noreferrer">Terraform Glossary</a>. If you see unfamiliar terms, such as <a href=https://www.terraform.io/docs/glossary#root-module target=_blank rel="noopener noreferrer">Root Module</a>, check the external glossary.</p><p><strong>Why Focus on Modules?</strong></p><p>Publishing a Terraform module is the gold-standard for easing AWS customer on-boarding to new services. Modules allow for flexible but opinionated deployments that follow AWS best practices and enforce proper security. For questions, please contact AWS I&A: <a href=mailto:aws-ia-eng@amazon.com>aws-ia-eng@amazon.com</a></p><h2 id=table-of-contents>Table of Contents</h2><ul><li><a href=#-module-structure>Module Structure</a></li><li><a href=#-provider-configuration-guidelines>Provider Configuration Guidelines</a></li><li><a href=#-general-hcl-configuration-guidelines>General HCL Configuration Guidelines</a></li><li><a href=#-variables-declaration-guidelines>Variable & Output Declaration Guidelines</a></li><li><a href=#-output-guidelines>Output Declaration Guidelines</a></li><li><a href=#-pull-request-guidelines>Pull Request Guidelines</a></li></ul><h2 id=module-structure>Module Structure</h2><p>All modules must maintain a similar structure that contains module code, examples, sub-modules (optional), and functional tests. These are laid out in our terraform repo template as boilerplate but are also detailed here:</p><h3 id=example-repo---terraform-aws-labelhttpsgithubcomaws-iaterraform-aws-label><strong>Example repo - <a href=https://github.com/aws-ia/terraform-aws-label target=_blank rel="noopener noreferrer">terraform-aws-label</a>:</strong></h3><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ tree
├── examples
│   ├── basic
│   │   ├── main.tf
│   │   ├── outputs.tf
│   │   └── variables.tf
│   └── formatted_tags
│       ├── main.tf
│       └── variables.tf
├── modules
│   └── my_sub_module/
├── test
│   ├── examples_basic_test.go
│   ├── examples_formatted_tags_test.go
│   └── label_test.go
</code></pre></div><p>All modules must contain at least one working deployment example. This is called <code>basic</code> by convention, but that is not required. Include examples for various usage patterns.</p><p>Examples can be complex at times because some deployments require large amounts of dependencies. In that case, you should include the required resources as a sub-module. <a href=https://github.com/aws-ia/terraform-aws-route53-recovery-controller/blob/main/examples/basic/main.tf#L23 target=_blank rel="noopener noreferrer">This module’s</a><code>basic</code> example requires a multi-region configuration to be deployed prior to testing the module’s components. This is accomplished by referencing a sub-module in <a href=https://github.com/aws-ia/terraform-aws-route53-recovery-controller/blob/main/examples/basic/main.tf#L23 target=_blank rel="noopener noreferrer">basic/main.tf</a>.</p><p>All modules must provide tests to guarantee provided functionality. Testing can be done using <a href=https://terratest.gruntwork.io/docs/getting-started/quick-start/ target=_blank rel="noopener noreferrer">Terratest</a> or the native <a href=https://www.terraform.io/language/modules/testing-experiment target=_blank rel="noopener noreferrer">Terraform Test</a> (at the time of writing this, <code>terraform test</code> is still experimental and alpha, <code>terratest</code> is preferred until future releases of <code>terraform test</code> ). Tests should verify each example as well any other functionality. Example specific tests should be titled <code>examples_&lt;example_name>_test.go</code>, tests that are generic to the module should be titled <code>&lt;module_name>_test.go</code></p><p>Please include your <code>go.mod</code> and <code>go.sum</code> files after running <code>go mod init github.com/aws-ia/&lt;module name></code></p><h3 id=file-naming><strong>File Naming:</strong></h3><p><strong>Most</strong> modules should contain only the following file names:</p><ul><li><code>main.tf</code> - Your Terraform resources</li><li><code>outputs.tf</code> - Module outputs</li><li><code>provider.tf</code> - The <a href=https://www.terraform.io/language/settings target=_blank rel="noopener noreferrer">terraform block</a> with <code>required_providers</code></li><li><code>variables.tf</code> - Variable declarations</li></ul><p><strong>Other common files:</strong></p><ul><li><code>data.tf</code> - Includes <code>locals</code> declarations and data sources. Note: its common to have an occasional local or data source in main.tf instead.</li><li><code>alias.tf</code> - Included if you have alias’ed providers to declare, <a href=https://github.com/aws-ia/terraform-aws-route53-recovery-controller/blob/main/alias.tf target=_blank rel="noopener noreferrer">example here.</a></li><li><code>versions.tf</code> - Alternate name for <code>provider.tf</code>. This convention comes from the <code>terraform0.12-upgrade</code> command where once terraform code was upgraded from v0.11.x to v0.12.x a <code>versions.tf</code> file was create to enforce <code>terraform { required_version = ">= 0.12.0}"</code></li></ul><p><strong>Service named files:</strong></p><p>Often users want to create several files and separate terraform resources by service. This urge should be stifled as much as possible in favor defining resources in main.tf. If a collection of resources, for example IAM Roles and Policies, exceed 150 lines then it is reasonable to break that into its own files such as iam.tf. Otherwise all resource code should be defined in the main.tf.</p><h2 id=provider-configuration-guidelines>Provider Configuration Guidelines</h2><p>Provider blocks should be declared in root modules by consumers of modules.</p><p>Provider blocks should not be declared in modules unless they are to specify <code>alias</code> providers to be used. No <a href=https://registry.terraform.io/providers/hashicorp/aws/latest/docs target=_blank rel="noopener noreferrer">authentication or configuration</a> parameters should be set unnecessarily to avoid enforcing arbitrary credential chain selections. If they must be set, they should be set using a variable with <code>default = null</code> to allow users to omit the configuration.</p><p>It is OK to define a <code>awscc</code> <code>user_agent</code> block in a module because these are appended to the provider block inherited from the root module.</p><h2 id=general-hcl-configuration-guidelines>General HCL Configuration Guidelines</h2><h3 id=resource-meta-name><strong>Resource Meta Name</strong></h3><p>Resource meta names should be snake-cased and should be contextual to the resource being created. Meta names should not be used generically, aka <code>aws_s3_bucket.self</code> and should not be repetitive, aka <code>aws_s3_bucket.bucket</code>.</p><p><strong>Examples:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=color:#66d9ef>data</span> <span style=color:#e6db74>&#34;aws_region&#34; &#34;current&#34;</span> {}
</code></pre></div><p>The resource meta name is “current” is contextual as the data provided is for the current region. It would be possible to create <code>data "aws_region" "alternative" {}</code> as well to provide region information for an alternative region.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_route53recoveryreadiness_cell&#34; &#34;per_region&#34;</span> {
  for_each  <span style=color:#f92672>=</span> <span style=color:#66d9ef>toset</span>(<span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>regions</span>)
  cell_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;${var.name}-${each.value}&#34;</span>
}
</code></pre></div><p>The resource meta name is contextual in that the resources created are looped over a region variable and are thus created <code>per_region</code>.</p><h3 id=resource-name>Resource Name</h3><p><strong>Use prefix attributes where possible</strong> - Many resources allow name values passed to generate randomness at the end using a prefix. Examples:</p><ul><li><code>[aws_iam_role](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/iam_role#argument-reference)</code> has both <code>name</code> and <code>name_prefix</code></li><li><code>[aws_s3_bucket](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/s3_bucket#argument-reference)</code> has both a <code>bucket</code> to name bucket and a <code>bucket_prefix</code> to name the bucket with a prefix.</li></ul><h3 id=dynamic-resources>Dynamic Resources</h3><h3 id=for_each-vs-count><code>for_each</code> vs <code>count</code></h3><p>Terraform can dynamically create resources using either <a href=https://www.terraform.io/language/meta-arguments/count#the-count-meta-argument target=_blank rel="noopener noreferrer">count</a> or <a href=https://www.terraform.io/language/meta-arguments/for_each target=_blank rel="noopener noreferrer">for_each</a>. <code>for_each</code> should <strong>always</strong> be preferred over <code>count</code> except for circumstances where only count = 0 or 1. The reasoning for this comes from the behavior fundamental to lists vs maps; Lists are ordered; say you create 3 subnets <code>[subnet0, subnet1, subnet2]</code> . if you have to erase subnet 0 or 1, terraforms state file will see a change to the list and cause cascading unexpected changes. Using <code>for_each</code> resources are named using the map key</p><p><code>aws_subnet.test[0].id</code> vs <code>aws_subnet.test["private_subnet0"].id</code></p><p>You can delete <code>"private_subnet0"</code> without any fear of unintended consequences.</p><h3 id=using-for_each-with-a-list>Using <code>for_each</code> with a list</h3><p>Because lists can be so helpful, you will often find a situation where you have a list and you want to create a resource dynamically. Since <code>for_each</code> requires a map, convert your list to a set <code>toset(var.mylist)</code> and terraform will use each entry as a key. Example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_ssm_parameter&#34; &#34;params_from_list&#34;</span> {
  for_each <span style=color:#f92672>=</span> <span style=color:#66d9ef>toset</span>([<span style=color:#e6db74>&#34;drew&#34;, &#34;tony&#34;, &#34;andy&#34;</span>])

  name  <span style=color:#f92672>=</span> <span style=color:#66d9ef>each</span>.<span style=color:#66d9ef>key</span>
  type  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;String&#34;</span>
  value <span style=color:#f92672>=</span> <span style=color:#66d9ef>each</span>.<span style=color:#66d9ef>value</span>
}

<span style=color:#960050;background-color:#1e0010>$</span> <span style=color:#66d9ef>terraform</span> <span style=color:#66d9ef>state</span> <span style=color:#66d9ef>list</span>
<span style=color:#66d9ef>aws_ssm_parameter</span>.<span style=color:#66d9ef>params_from_list</span>[<span style=color:#e6db74>&#34;drew&#34;</span>]
<span style=color:#66d9ef>aws_ssm_parameter</span>.<span style=color:#66d9ef>params_from_list</span>[<span style=color:#e6db74>&#34;tony&#34;</span>]
<span style=color:#66d9ef>aws_ssm_parameter</span>.<span style=color:#66d9ef>params_from_list</span>[<span style=color:#e6db74>&#34;andy&#34;</span>]

<span style=color:#960050;background-color:#1e0010>$</span> <span style=color:#66d9ef>terraform</span> <span style=color:#66d9ef>state</span> <span style=color:#66d9ef>show</span> <span style=color:#66d9ef>aws_ssm_parameter</span>.<span style=color:#66d9ef>params_from_list</span>[<span style=color:#e6db74>&#34;drew&#34;</span>]
{ ...
name  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;drew&#34;</span>
value <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;drew&#34;</span>
... }
</code></pre></div><h3 id=default-tags>Default Tags</h3><p>All resource that can accept tags should. The terraform <code>aws</code> provider has a <code>default_tags</code> feature should not be used inside a module in favor of allowing the root module to define <code>default_tags</code>.</p><h3 id=tags-with-awscc-support>Tags with AWSCC support</h3><p>If creating resources with both <code>aws</code> and <code>awscc</code> provider its helpful to have sanitized tags for each provider because the formats are different (<code>aws</code> is <code>{ tagname = tagvalue }</code> and <code>awscc</code> is <code>{ Key = tagname, Value = tagvalue }</code>. The <a href=https://github.com/aws-ia/terraform-aws-label target=_blank rel="noopener noreferrer">terraform-aws-label</a> module can accept either provider version and outputs tags formatted for both.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=color:#66d9ef>module</span> <span style=color:#e6db74>&#34;aws_tags&#34;</span> {
  source <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;aws-ia/label/aws&#34;</span><span style=color:#75715e>
</span><span style=color:#75715e>
</span><span style=color:#75715e>  # AWS provider format as input
</span><span style=color:#75715e></span>  tags <span style=color:#f92672>=</span> {
    <span style=color:#e6db74>&#34;service&#34; : &#34;authorize&#34;</span>,
    <span style=color:#e6db74>&#34;managed_by&#34; : &#34;terraform&#34;</span>
  }
}

<span style=color:#66d9ef>module</span> <span style=color:#e6db74>&#34;awscc_tags&#34;</span> {
  source <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;aws-ia/label/aws&#34;</span><span style=color:#75715e>
</span><span style=color:#75715e>
</span><span style=color:#75715e>  # AWSCC provider format
</span><span style=color:#75715e></span>  tags <span style=color:#f92672>=</span> [
    { <span style=color:#e6db74>&#34;key&#34; : &#34;service&#34;, &#34;value&#34; : &#34;measurements&#34;</span> },
    { &#34;key&#34; <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;managed_by&#34;, &#34;value&#34; : &#34;terraform&#34;</span> }
  ]
}<span style=color:#75715e>
</span><span style=color:#75715e>
</span><span style=color:#75715e># To use outputtted tags formatted for aws provider
</span><span style=color:#75715e></span><span style=color:#66d9ef>module</span>.<span style=color:#66d9ef>aws_tags</span>.<span style=color:#66d9ef>aws_tags</span>
<span style=color:#66d9ef>module</span>.<span style=color:#66d9ef>awscc_tags</span>.<span style=color:#66d9ef>aws_tags</span><span style=color:#75715e>
</span><span style=color:#75715e>
</span><span style=color:#75715e># To use outputtted tags formatted for awscc provider
</span><span style=color:#75715e></span><span style=color:#66d9ef>module</span>.<span style=color:#66d9ef>aws_tags</span>.<span style=color:#66d9ef>tags</span>
<span style=color:#66d9ef>module</span>.<span style=color:#66d9ef>awscc_tags</span>.<span style=color:#66d9ef>tags</span>
</code></pre></div><h3 id=prefer-attachment-resources-over-embedded>Prefer “Attachment” Resources over Embedded</h3><p>Some resources have pseudo resources embedded as attributes in them. Where possible, you should avoid using these embedded resource attributes and instead you should use the unique resource to attach that pseudo-resource. These resource relationships can cause chicken/egg issues that are unique per resource. Example is <code>aws_security_group</code>:</p><p><strong>Using embedded attribute (avoid this pattern):</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_security_group&#34; &#34;allow_tls&#34;</span> {
  ...
  <span style=color:#66d9ef>ingress</span> {
    description      <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;TLS from VPC&#34;</span>
    from_port        <span style=color:#f92672>=</span> <span style=color:#ae81ff>443</span>
    to_port          <span style=color:#f92672>=</span> <span style=color:#ae81ff>443</span>
    protocol         <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;tcp&#34;</span>
    cidr_blocks      <span style=color:#f92672>=</span> [<span style=color:#66d9ef>aws_vpc</span>.<span style=color:#66d9ef>main</span>.<span style=color:#66d9ef>cidr_block</span>]
    ipv6_cidr_blocks <span style=color:#f92672>=</span> [<span style=color:#66d9ef>aws_vpc</span>.<span style=color:#66d9ef>main</span>.<span style=color:#66d9ef>ipv6_cidr_block</span>]
  }

  <span style=color:#66d9ef>egress</span> {
    from_port        <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
    to_port          <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>
    protocol         <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;-1&#34;</span>
    cidr_blocks      <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;0.0.0.0/0&#34;</span>]
    ipv6_cidr_blocks <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#34;::/0&#34;</span>]
  }
}
</code></pre></div><p><strong>With attachment resources (preferred):</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_security_group&#34; &#34;allow_tls&#34;</span> {
  ...
}

<span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;aws_security_group_rule&#34; &#34;example&#34;</span> {
  type              <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ingress&#34;</span>
  description      <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;TLS from VPC&#34;</span>
  from_port        <span style=color:#f92672>=</span> <span style=color:#ae81ff>443</span>
  to_port          <span style=color:#f92672>=</span> <span style=color:#ae81ff>443</span>
  protocol         <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;tcp&#34;</span>
  cidr_blocks      <span style=color:#f92672>=</span> [<span style=color:#66d9ef>aws_vpc</span>.<span style=color:#66d9ef>main</span>.<span style=color:#66d9ef>cidr_block</span>]
  ipv6_cidr_blocks <span style=color:#f92672>=</span> [<span style=color:#66d9ef>aws_vpc</span>.<span style=color:#66d9ef>main</span>.<span style=color:#66d9ef>ipv6_cidr_block</span>]
  security_group_id <span style=color:#f92672>=</span> <span style=color:#66d9ef>aws_security_group</span>.<span style=color:#66d9ef>allow_tls</span>.<span style=color:#66d9ef>id</span>
}
</code></pre></div><h2 id=variables-declaration-guidelines>Variables Declaration Guidelines</h2><p>Module variables are useful in most situations. Knowing which default values to set is crucial. Here we outline some usage patterns and advanced usage considerations.</p><h3 id=variable--output-declarations>Variable & Output Declarations</h3><p>All variables must have a defined <code>type</code> and <code>description</code>.</p><h3 id=required-variables>Required Variables</h3><p>To make a variable required for user to set, omit a <code>default</code> in the variable declaration and <a href=https://www.terraform.io/language/values/variables#disallowing-null-input-values target=_blank rel="noopener noreferrer">consider if setting</a> <code>nullable = false</code> makes sense.</p><h3 id=disruptive-optional-attributes-as-variables>Disruptive Optional Attributes as Variables</h3><p>Many resource attributes are disruptive to the API calls for <code>Create</code> and <code>Update</code> conditions. For example, <code>aws_vpc</code> requires either a defined <code>cidr_block</code> or deriving a cidr from AWS IPAM using <code>ipv4_ipam_pool_id</code> and <code>ipv4_netmask_length</code>, however, you cannot pass all 3 attributes to the API even of they’re empty.</p><p>To account for situations like this, you can define the variable with a <code>default = null</code> , if the null value is used with the resource, terraform omits the attribute from the configuration.</p><h3 id=variable-value-validation>Variable Value Validation</h3><p>Terraform allows you to <a href=https://www.terraform.io/language/values/variables#custom-validation-rules target=_blank rel="noopener noreferrer">validate the content</a> a user passes to a variable. This should be used as appropriate. Examples:</p><p><strong>Example: Can be either <code>assertion</code> or <code>gating</code>:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;safety_rule_type&#34;</span> {
  description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Type of safety rules to create. Can only be \&#34;assertion\&#34; or \&#34;gating\&#34;.&#34;</span>
  type        <span style=color:#f92672>=</span> <span style=color:#66d9ef>string</span>
  default     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;assertion&#34;</span>

  <span style=color:#66d9ef>validation</span> {
    condition     <span style=color:#f92672>=</span> var.safety_rule_type <span style=color:#f92672>==</span> lower(&#34;assertion&#34;) || var.safety_rule_type <span style=color:#f92672>==</span> <span style=color:#66d9ef>lower</span>(<span style=color:#e6db74>&#34;gating&#34;</span>)
    error_message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Safety rule type can only be \&#34;assertion\&#34; or \&#34;gating\&#34;.&#34;</span>
  }
}
</code></pre></div><p><strong>Example: Key in map must look like a valid AWS Region:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;cells_definition&#34;</span> {
  description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Nested map where the key is a region you want to enable and keys referring to resource arns to enable. Services enabled are defined in `var.resource_type_name`. For examples, see the variables.tf file&#34;</span>

  type <span style=color:#f92672>=</span> <span style=color:#66d9ef>map</span>(<span style=color:#66d9ef>map</span>(<span style=color:#66d9ef>string</span>))
  <span style=color:#66d9ef>validation</span> {
    condition <span style=color:#f92672>=</span> <span style=color:#66d9ef>alltrue</span>([<span style=color:#66d9ef>for</span> <span style=color:#66d9ef>_</span>, <span style=color:#66d9ef>k</span> <span style=color:#66d9ef>in</span> <span style=color:#66d9ef>keys</span>(<span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>cells_definition</span>) <span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#66d9ef>can</span>(<span style=color:#66d9ef>regex</span>(<span style=color:#e6db74>&#34;[a-z][a-z]-[a-z]+-[1-9]&#34;</span>, <span style=color:#66d9ef>k</span>))])
    error_message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Supported service names are the keys defined in var.resource_type_name .&#34;</span>
  }
}
</code></pre></div><h3 id=custom-objects>Custom Objects</h3><p>Terraform allows you to create <a href=https://www.terraform.io/language/values/variables#object target=_blank rel="noopener noreferrer">custom object types</a> to constrain input that is allowed.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;safety_rules&#34;</span> {
  description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Configuration of the Safety Rules. Key is the name applied to the rule.&#34;</span>

  type <span style=color:#f92672>=</span> <span style=color:#66d9ef>map</span>(<span style=color:#66d9ef>object</span>({
    wait_period_ms <span style=color:#f92672>=</span> <span style=color:#66d9ef>number</span>
    inverted       <span style=color:#f92672>=</span> <span style=color:#66d9ef>bool</span>
    threshold      <span style=color:#f92672>=</span> <span style=color:#66d9ef>number</span>
    type           <span style=color:#f92672>=</span> <span style=color:#66d9ef>string</span>
    name_suffix    <span style=color:#f92672>=</span> <span style=color:#66d9ef>string</span>
  }))
}
</code></pre></div><p>The attributes may be made optional using the <a href=https://www.terraform.io/language/expressions/type-constraints#experimental-optional-object-type-attributes target=_blank rel="noopener noreferrer">experimental feature</a> <code>module_variable_optional_attrs</code> which is set in your terraform block:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=color:#66d9ef>terraform</span> {
  required_version <span style=color:#f92672>=</span> &#34;&gt;<span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>.<span style=color:#ae81ff>15</span>.<span style=color:#ae81ff>0</span><span style=color:#960050;background-color:#1e0010>&#34;</span>
  experiments      <span style=color:#f92672>=</span> [<span style=color:#66d9ef>module_variable_optional_attrs</span>]
  <span style=color:#66d9ef>required_providers</span> {
    aws <span style=color:#f92672>=</span> {
      source  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;hashicorp/aws&#34;</span>
      version <span style=color:#f92672>=</span> &#34;&gt;<span style=color:#f92672>=</span> <span style=color:#ae81ff>3</span>.<span style=color:#ae81ff>68</span><span style=color:#960050;background-color:#1e0010>&#34;</span>
    }
  }
}

<span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;hosted_zone&#34;</span> {
  description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Info about the hosted zone. If the `name` or `zone_id` is not passed, a search will be performed using the values provided. Leave null to not create Route53 Alias records (required for LB functionality).&#34;</span>

  type <span style=color:#f92672>=</span> <span style=color:#66d9ef>object</span>({
    name         <span style=color:#f92672>=</span> <span style=color:#66d9ef>optional</span>(<span style=color:#66d9ef>string</span>)
    private_zone <span style=color:#f92672>=</span> <span style=color:#66d9ef>optional</span>(<span style=color:#66d9ef>bool</span>)
    vpc_id       <span style=color:#f92672>=</span> <span style=color:#66d9ef>optional</span>(<span style=color:#66d9ef>number</span>)
    tags         <span style=color:#f92672>=</span> <span style=color:#66d9ef>optional</span>(<span style=color:#66d9ef>map</span>(<span style=color:#66d9ef>string</span>))
    zone_id      <span style=color:#f92672>=</span> <span style=color:#66d9ef>optional</span>(<span style=color:#66d9ef>string</span>)
  })

  default <span style=color:#f92672>=</span> {
    name    <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>
    zone_id <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>
  }
}
</code></pre></div><h3 id=validation-vs-custom-objects>Validation vs Custom Objects</h3><p>Custom objects are very nice but if used with <code>optional()</code> the resultant keys are set within the object as <code>null</code> unless specified. This can occasionally <a href=https://discuss.hashicorp.com/t/experiment-feedback-optional-attribute-keys-should-not-be-included-in-variable-value-unless-specified/34063 target=_blank rel="noopener noreferrer">cause a hinderance .</a> Sometimes it is better to avoid defining a custom object and instead enforce organization using <code>validation</code> blocks instead. Example:</p><p><strong>First key must be like a valid region, 2nd key must be contained in a list:</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=color:#75715e>/*
</span><span style=color:#75715e>cells_definition = {
</span><span style=color:#75715e>  us-west-2 = {
</span><span style=color:#75715e>     elasticloadbalancing = &#34;arn:aws:elasticloadbalancing:us-west-2:&lt;&gt;:loadbalancer/app/&lt;&gt;&#34;
</span><span style=color:#75715e>     autoscaling          = &#34;arn:aws:autoscaling:us-west-2:&lt;&gt;:autoScalingGroup:*:autoScalingGroupName/&lt;&gt;
</span><span style=color:#75715e>  }
</span><span style=color:#75715e>}
</span><span style=color:#75715e>*/</span>

<span style=color:#66d9ef>validation</span> {
  condition <span style=color:#f92672>=</span> <span style=color:#66d9ef>alltrue</span>([<span style=color:#66d9ef>for</span> <span style=color:#66d9ef>_</span>, <span style=color:#66d9ef>k</span> <span style=color:#66d9ef>in</span> <span style=color:#66d9ef>keys</span>(<span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>cells_definition</span>) <span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#66d9ef>can</span>(<span style=color:#66d9ef>regex</span>(<span style=color:#e6db74>&#34;[a-z][a-z]-[a-z]+-[1-9]&#34;</span>, <span style=color:#66d9ef>k</span>))]) <span style=color:#960050;background-color:#1e0010>&amp;&amp;</span> <span style=color:#66d9ef>alltrue</span>(<span style=color:#66d9ef>flatten</span>([
     <span style=color:#66d9ef>for</span> <span style=color:#66d9ef>arns</span> <span style=color:#66d9ef>in</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>cells_definition</span> <span style=color:#960050;background-color:#1e0010>:</span> [
     <span style=color:#66d9ef>for</span> <span style=color:#66d9ef>service</span>, <span style=color:#66d9ef>arn</span> <span style=color:#66d9ef>in</span> <span style=color:#66d9ef>arns</span> <span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#66d9ef>contains</span>([<span style=color:#e6db74>&#34;apigateway&#34;, &#34;autoscaling&#34;, &#34;cloudwatch&#34;, &#34;dynamodb&#34;, &#34;ec2-volume&#34;</span>,
                                            <span style=color:#e6db74>&#34;ec2-vpc&#34;, &#34;ec2-vpn-gw&#34;, &#34;ec2-vpn-cgw&#34;, &#34;ec2-vpn-conn&#34;, &#34;elasticloadbalancing&#34;</span>,
                                            <span style=color:#e6db74>&#34;kafka&#34;, &#34;lambda&#34;, &#34;rds&#34;, &#34;route53&#34;, &#34;sns&#34;, &#34;sqs&#34;</span>], <span style=color:#66d9ef>service</span>)
     ]
  ]))
error_message <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;Supported service names are the keys defined in var.resource_type_name.&#34;</span>
}
</code></pre></div><h2 id=output-guidelines>Output Guidelines</h2><p>Terraform allows you to provide formatted outputs from your modules. There are several ways to think about these. Many times you can assume which output values will be most relevant to your end user. When choosing which values to output think about:</p><ul><li>How will your module be used in a root module?</li><li>How will your module be used as a <code>data.terraform_remote_state</code>?</li><li>Does it make sense to output entire resources instead of formatted output?</li></ul><h2 id=pull-request-guidelines>Pull Request Guidelines</h2><p>Soon™ we will have a shared CI process across all I&A modules. In the mean time, documented here are the expectations for code submitted as a PR. Details about the upcoming CI can be found in the FAQ.</p><h3 id=documentation>Documentation</h3><p>READMEs should be auto-generated using <a href=https://github.com/terraform-docs/terraform-docs target=_blank rel="noopener noreferrer">terraform-docs</a>. A common pattern used is to define a <code>.terraform-docs.yaml</code> in the <a href=https://github.com/aws-ia/terraform-aws-route53-recovery-controller/blob/main/.terraform-docs.yaml target=_blank rel="noopener noreferrer">root</a>, using a header for instructional documentation and the <code>terraform-docs</code> table appended to the bottom for content about provider versions, variable documentation, etc.</p><p>You must also run <code>terraform fmt -recursive</code> in your root directory.</p><h3 id=static-analysis>Static Analysis</h3><p>Required Tools:</p><ul><li><a href=https://github.com/terraform-linters/tflint target=_blank rel="noopener noreferrer">tflint</a></li><li><a href=https://aquasecurity.github.io/tfsec/ target=_blank rel="noopener noreferrer">tfsec</a></li><li><a href=https://kics.io/ target=_blank rel="noopener noreferrer">kics</a></li></ul><p>Run <a href=https://github.com/terraform-linters/tflint target=_blank rel="noopener noreferrer">tflint</a>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>$ tflint --only<span style=color:#f92672>=</span>terraform_deprecated_interpolation --only<span style=color:#f92672>=</span>terraform_deprecated_index --only<span style=color:#f92672>=</span>terraform_unused_declarations --only<span style=color:#f92672>=</span>terraform_comment_syntax --only<span style=color:#f92672>=</span>terraform_documented_outputs --only<span style=color:#f92672>=</span>terraform_documented_variables --only<span style=color:#f92672>=</span>terraform_typed_variables --only<span style=color:#f92672>=</span>terraform_module_pinned_source --only<span style=color:#f92672>=</span>terraform_naming_convention --only<span style=color:#f92672>=</span>terraform_required_version --only<span style=color:#f92672>=</span>terraform_required_providers --only<span style=color:#f92672>=</span>terraform_standard_module_structure --only<span style=color:#f92672>=</span>terraform_workspace_remote
</code></pre></div><p>Run <a href=https://aquasecurity.github.io/tfsec/ target=_blank rel="noopener noreferrer">tfsec</a> in all root modules:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>tfsec .
</code></pre></div><p>Run <a href=https://kics.io/ target=_blank rel="noopener noreferrer">kics</a> in your root directory:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>kics scan -p ./ -o ./
</code></pre></div><p><strong>TODO</strong>: update kics or tfsec (need to determine which) to ignore overlapping tests</p><p>Your best judgement should be used when ignoring linting & security findings. For precarious <code>ignore</code>s please provide an explanation in the PR and/or via comment in the codebase.</p><h2 id=semantic-versioning>Semantic Versioning</h2><p>Official releases should be published using Github tags and releases based on <a href=https://semver.org/ target=_blank rel="noopener noreferrer">semantic versioning</a> guidelines. Once 1.0.0 has been published, you must consider module functionality lifecycle, breaking changes must be marked accordingly.</p><p>Release titles should be <code>vX.X.X</code>, tags should be <code>X.X.X</code></p><h2 id=publishing-to-terraform-registry>Publishing to Terraform Registry</h2><p>Each module must be published to the Terraform Registry once its ready for use. Once the entry is created, future tags flow automatically to the registry. The initial creation will soon be automated. In the meantime, please reach out to the I&A team to create initial registry entries for new modules.</p></div></div></div><div id=navigation></div></section><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=./js/clipboard.min.js?1645718475></script>
<script src=./js/perfect-scrollbar.min.js?1645718475></script>
<script src=./js/perfect-scrollbar.jquery.min.js?1645718475></script>
<script src=./js/jquery.sticky.js?1645718475></script>
<script src=./js/featherlight.min.js?1645718475></script>
<script src=./js/highlight.pack.js?1645718475></script>
<script>hljs.initHighlightingOnLoad()</script><script src=./js/modernizr.custom-3.6.0.js?1645718475></script>
<script src=./js/learn.js?1645718475></script>
<script src=./js/hugo-learn.js?1645718475></script>
<script src=./mermaid/mermaid.js?1645718475></script>
<script>mermaid.initialize({startOnLoad:!0})</script></body></html>